# Ядро генерации — Этап 1 (демо без UI)

## Что это
Базовый модуль, который принимает параметры (тема, цель, ключевые слова, тон, структура, объём)
и собирает системный промпт для модели.

## Файлы
- `config.py` — дефолтные настройки.
- `helpers.py` — утилиты форматирования.
- `rules_engine.py` — сборка промпта (`build_prompt(data)`).
- `base_prompt.txt` — шаблон промпта.
- `input_example.json` — пример входных данных.
- `run_demo.py` — проверка без UI.
- `docs/implementation_overview.md` — техническая документация с обзором архитектуры и зависимостей.

## Быстрый старт
```bash
python3 -m venv venv
# macOS/Linux:
source venv/bin/activate
# Windows (PowerShell):
# venv\Scripts\activate

python run_demo.py

```

## Локальный запуск API и фронтенда

```bash
# UI и API в одном процессе (Flask сервит фронт и REST API)
python -m server

# Только API (например, без UI)
make api

# Flask-сервер в режиме разработки
make dev
```

### Быстрый smoke-тест API

```bash
make health                 # /api/health
make reindex SMOKE_THEME=finance   # /api/reindex (тематика задаётся через SMOKE_THEME)
make generate-dry SMOKE_THEME=finance  # /api/generate в dry-run режиме
```

> В `generate-dry` используется специальный ответ, который не вызывает модель — им удобно проверять, что фронтенд/бэкенд связаны корректно.

## Управление сгенерированными материалами

- Во вкладке «Сгенерированные материалы» каждая карточка получила кнопку «Удалить». Подтверждение приводит к синхронному удалению `.md` и `.json` из `artifacts/`, обновлению индекса и мгновенному скрытию карточки. Пользователь видит короткий тост «Удалено».
- Если файл уже отсутствует (например, удалён вручную), попытка открыть или скачать артефакт не вызывает красную ошибку: карточка автоматически исчезает, а интерфейс показывает мягкое уведомление «Файл недоступен: запись удалена из списка».
- Кнопка «Очистить список» запускает reconcile/cleanup — сервер сравнивает индекс с содержимым `artifacts/` и удаляет осиротевшие записи. Та же процедура выполняется автоматически при каждом запросе `/api/artifacts`, поэтому битые карточки исчезают лениво и без задержки.
- В REST API доступны вспомогательные маршруты:
  - `DELETE /api/artifacts` — принимает JSON с `id` и/или `path`, удаляет файлы и запись в индексе. В ответе приходят флаги `deleted`, `not_found`, `index_updated` и массив `errors` (при частичных сбоях возвращается HTTP 207). Повторные вызовы для одного и того же ID идемпотентны.
  - `POST /api/artifacts/cleanup` — выполняет ручную очистку, возвращая количество проверенных (`checked`) и удалённых (`removed`) записей и список `removed_ids`.

## Расширенные настройки

Интерфейс блока упрощён: он свёрнут по умолчанию (состояние запоминается в `localStorage`) и показывается как аккордеон «Расширенные настройки ⯈». Пока пользователь не открывает панель, генерация использует GPT-5 и стандартные значения `max_tokens` и `k`.

Внутри размещены две пользовательские опции и технические подразделы:

- **FAQ** — переключатель, который добавляет блок часто задаваемых вопросов к финальному материалу.
- **JSON-LD** — переключатель, включающий SEO-разметку для поисковых систем.
- **Параметры модели** — модель зафиксирована на GPT-5, доступно только числовое поле для `max_tokens` и параметр `k`.
- **Техподдержка** — кнопки «Reindex theme» и «Health check» для диагностики. Они отображаются только когда разрешены dev-действия (`SHOW_DEV_ACTIONS=true`).



FAQ и JSON-LD остаются единственными «человекоориентированными» переключателями: остальные настройки в блоке нужны для тонкой настройки модели или обслуживания.

### Ключевые слова

- Поле «Ключевые слова» в брифе необязательное: генерация стабильно запускается даже с пустым значением.
- Автоподбор включён по умолчанию. При необходимости его можно отключить чекбоксом под полем — тогда промпт соберётся без SEO-блока.
- Если ключи заданы вручную, они имеют приоритет: система добавляет только уникальные варианты поверх них, избавляясь от дублей.
- В отчёте (`keywords_final`, `keywords_manual`, `keywords_auto`) и в UI отображается точный список использованных ключей.

## RAG-ready (Stage 1)

### Profiles layout
- `profiles/<theme>/exemplars/` — тематические фрагменты по 200–700 слов (одно ключевое сообщение на файл, нейтральный Markdown). Пример: `profiles/finance/exemplars/{001_intro.md, 002_benefits.md, 003_faq.md}`.
- `profiles/<theme>/glossary.txt` — короткие термины и определения одной строкой.
- `profiles/<theme>/style_guide.md` — тон, do/don't, политика заголовков и локализации.
- `profiles/<theme>/style_samples/` — дополнительные эталонные примеры в Markdown, полученные из исходников (`.docx`, `.pdf` и т. п.).
- `profiles/<theme>/style_profile.md` — правила подачи: разделы «Как писать», «Как не писать», ссылки на эталонные примеры.

### Оркестрация без LLM
- `assemble_messages.py` — собирает системный промпт и добавляет `CONTEXT`, когда `retrieve_exemplars()` начнёт возвращать фрагменты.
- `retrieve_exemplars(theme_slug, query, k=3)` — контракт Stage 2: должен отдавать список словарей вида `{ "path": str, "text": str, "score": float }`, подобранных под токен-бюджет (~500–700 токенов суммарно).
- Итоговый формат сообщений: `[{"role": "system", ...}, опциональный CONTEXT, {"role": "user", "content": "Сгенерируй текст по указанным параметрам."}]`.

### Тестирование Stage 1
- `python run_demo.py` — базовый поток (без изменений).
- `python validate_prompt.py` — проверка наличия секций и ключевых слов в промпте.
- `python assemble_messages.py` — печатает предпросмотр system и CONTEXT (пока пусто).
- `python prompt_to_file.py` — сохраняет промпт в `./artifacts/prompt_<timestamp>.txt`.

### Сквозной прогон с генерацией статьи
1. Собери индекс (один раз или при изменении клипов): `python -m retrieval index --theme finance`
2. Запусти генерацию: `python orchestrate.py --theme finance --data input_example.json --k 3`
3. Результат смотри в `artifacts/*.md` и соседнем `.json` с метаданными.

#### Пример пакетного запуска

Создайте `batch.json` с массивом заданий (можно использовать YAML с теми же полями):

```json
[
  {
    "theme": "finance",
    "data": "input_example.json",
    "k": 0,
    "outfile": "artifacts/finance_draft.md"
  },
  {
    "theme": "finance",
    "data": "input_example.json",
    "k": 3,
    "outfile": "artifacts/finance_context.md"
  },
  {
    "theme": "mortgage",
    "data": "mock_data/mortgage.json",
    "k": 2,
    "outfile": "artifacts/mortgage.md"
  }
]
```

Запустите генерацию для всех элементов одним вызовом:

```bash
python orchestrate.py --batch batch.json --mode draft
```

Каждое задание сохранит статью и метаданные в указанный `outfile` и соседний `.json`.

#### A/B сравнение без и с контекстом

Чтобы сравнить генерацию без CONTEXT и с выбранным `k`, используйте режим `--ab compare`:

```bash
python orchestrate.py --theme finance --data input_example.json --k 3 --ab compare
```

В каталоге `artifacts/` появятся файлы с суффиксами `__A` (без CONTEXT) и `__B` (с CONTEXT),
а рядом с каждым — `.json` с метаданными. Команда выводит длины и длительность обоих прогонов для быстрого сравнения.

### Ready for Stage 2, когда
- Структура профилей создана минимум для одной темы с 2–3 заготовками.
- `base_prompt.txt` знает про блок CONTEXT.
- Существуют стабы `retrieve_exemplars` и `assemble_messages` без внешних зависимостей.
- В проект не добавлены внешние библиотеки и сетевые вызовы.

## 💬 Стилевые профили

В фабрике контента поддерживаются стилевые профили для отдельных тематик. Для темы Finance автоматически подключается эталонный стиль с короткими пояснениями и чёткими инструкциями. Отключить можно через параметр `style_profile=off` или одноимённую переменную окружения.

### Как обновить стиль Finance
1. Скопируйте новые эталонные материалы в `profiles/finance/exemplars/` (оригинальные форматы допустимы, например `.docx`).
2. Конвертируйте тексты в Markdown и положите файлы в `profiles/finance/style_samples/`. Названия — осмысленные, без пробелов.
3. Обновите правила и ссылки внутри `profiles/finance/style_profile.md` (разделы «Как писать/не писать» и список примеров).
4. Запустите `Reindex theme` для `finance` — кнопку в UI или `make reindex SMOKE_THEME=finance`. Переиндексация сбрасывает кэш стилевого профиля: новые правила и примеры сразу попадут в системный промпт.

> Подмешивается только краткий профиль: сами Markdown-примеры в промпт не вставляются, но доступны авторам для изучения.

## Troubleshooting

- **OpenAI key** — убедитесь, что переменная окружения `OPENAI_API_KEY` доступна перед запуском `python -m server`. UI покажет статус «OpenAI key не найден», если ключ отсутствует.
- **Индекс** — если карточка Health говорит `index missing`, соберите индекс: `python -m retrieval index --theme <slug>`. После переиндексации обновите статус кнопкой «Health check».
- **Артефакты** — директория `artifacts/` должна существовать и быть доступной на запись. Создайте её вручную (`mkdir -p artifacts`), если запускаете проект впервые.
- **CORS / удалённый доступ** — сервер уже отдаёт заголовки CORS для `/api/*`. При запуске на другом хосте используйте `python -m server --host 0.0.0.0 --port 8000` и открывайте UI по `http://<host>:<port>`.

